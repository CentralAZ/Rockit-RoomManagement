// Fluidbox
// Description: Replicating the seamless lightbox transition effect seen on Medium.com, with some improvements
// Version: 1.2
// Author: Terry Mun
// Author URI: http://terrymun.com

// Paul Irish's debounced resize event
(function(c,b){var a=function(g,d,e){var h;return function f(){var k=this,j=arguments;function i(){if(!e){g.apply(k,j)}h=null}if(h){clearTimeout(h)}else{if(e){g.apply(k,j)}}h=setTimeout(i,d||100)}};jQuery.fn[b]=function(d){return d?this.bind("resize",a(d)):this.trigger(b)}})(jQuery,"smartresize");

// Fluidbox plugin
(function(a){a.fn.fluidbox=function(f){var e=a.extend(true,{viewportFill:0.95,debounceResize:true,closeTrigger:[{selector:"#fluidbox-overlay",event:"click"}]},f);a("body").append('<div id="fluidbox-overlay" />');var d=this,g=a(window),c,b=function(){a(".fluidbox-opened").trigger("click")},i=function(m){var k=m.find("img"),l=m.find(".fluidbox-ghost"),o=g.scrollTop()-k.offset().top+0.5*(k.data("imgHeight")*(k.data("imgScale")-1))+0.5*(g.height()-k.data("imgHeight")*k.data("imgScale")),j=0.5*(k.data("imgWidth")*(k.data("imgScale")-1))+0.5*(g.width()-k.data("imgWidth")*k.data("imgScale"))-k.offset().left,n=k.data("imgScale");l.css({transform:"translate("+parseInt(j*10)/10+"px,"+parseInt(o*10)/10+"px) scale("+parseInt(n*1000)/1000+")"})},h=function(){c=g.width()/g.height();d.each(function(){var k=a(this).find("img"),l=a(this).find(".fluidbox-ghost"),j=a(this).find(".fluidbox-wrap"),m=k.data();m.imgWidth=k.width();m.imgHeight=k.height();m.imgRatio=k.width()/k.height();l.css({width:k.width(),height:k.height(),top:k.offset().top-j.offset().top,left:k.offset().left-j.offset().left});if(c>m.imgRatio){m.imgScale=g.height()*e.viewportFill/k.height()}else{m.imgScale=g.width()*e.viewportFill/k.width()}})};if(e.closeTrigger){a.each(e.closeTrigger,function(j){if(e.closeTrigger[j].selector!="window"){a(document).on(e.closeTrigger[j].event,e.closeTrigger[j].selector,b)}else{g.on(e.closeTrigger[j].event,b)}})}d.imagesLoaded().done(function(){d.each(function(){if(a(this).is("a")&&a(this).children().length===1&&a(this).children().is("img")){a(this).addClass("fluidbox").wrapInner('<div class="fluidbox-wrap" />').find("img").css({opacity:1}).after('<div class="fluidbox-ghost" />')}});h();var j=function(){h();var k=a("a[data-fluidbox].fluidbox-opened");if(k.length>0){i(k)}};if(e.debounceResize){a(window).smartresize(j)}else{a(window).resize(j)}d.click(function(o){var n=a(this),l=a(this).find("img"),m=a(this).find(".fluidbox-ghost");if(a(this).data("fluidbox-state")===0||!a(this).data("fluidbox-state")){a(this).data("fluidbox-state",1).removeClass("fluidbox-closed").addClass("fluidbox-opened");a("#fluidbox-overlay").fadeIn();m.css({"background-image":"url("+l.attr("src")+")",opacity:1});l.css({opacity:0});var k=new Image();k.onload=function(){m.css({"background-image":"url("+n.attr("href")+")"})};k.src=a(this).attr("href");i(a(this))}else{a(this).data("fluidbox-state",0).removeClass("fluidbox-opened").addClass("fluidbox-closed");a("#fluidbox-overlay").fadeOut();l.css({opacity:1});m.css({transform:"translate(0,0) scale(1)"}).one("webkitTransitionEnd MSTransitionEnd oTransitionEnd otransitionend transitionend",function(){m.css({opacity:0})})}o.preventDefault()})});return d}})(jQuery);